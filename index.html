<!DOCTYPE html>
<html>
<head>
    <title>FACON - 기프티콘 낚시</title>
    <meta charset="utf-8"/>
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
</head>
<body>
    <button id="kakao-login-btn">카카오 로그인</button>

    <h3>내 닉네임:</h3>
    <div id="nickname-display"></div>

    <h3>친구 목록:</h3>
    <div id="friend-list" style="margin-bottom:20px;"></div>

    <script>
        Kakao.init('4c62b1f03c15f3974661385234e62229');

        let selectedFriendUUID = null;

        // 내 닉네임 표시
        function showNickname() {
            Kakao.API.request({ url: '/v2/user/me' })
            .then(res => {
                const nickname = res.properties.nickname;
                document.getElementById('nickname-display').textContent = nickname;
                console.log('내 닉네임:', nickname);
            })
            .catch(err => console.error('사용자 정보 요청 실패:', err));
        }

        // 친구 목록 중 하나 선택 가능하도록 버튼 생성 (맥도날드만)
        function showFriends() {
            Kakao.API.request({ url: '/v1/api/talk/friends' })
            .then(res => {
                if (!res.elements || res.elements.length === 0) {
                    alert('친구가 없습니다.');
                    return;
                }
                const friendListDiv = document.getElementById('friend-list');
                friendListDiv.innerHTML = '';

                const macdonaldFriend = res.elements.find(f => f.profile_nickname === '맥도날드');
                if (!macdonaldFriend) {
                    alert('맥도날드 친구가 없습니다.');
                    return;
                }

                const btn = document.createElement('button');
                btn.textContent = '맥도날드 세트 선물 보내기';
                btn.onclick = () => {
                    selectedFriendUUID = macdonaldFriend.uuid;
                    sendGift();
                };
                friendListDiv.appendChild(btn);
            })
            .catch(err => console.error('친구 목록 요청 실패:', err));
        }

        // 메시지 전송
        function sendGift() {
            if (!selectedFriendUUID) {
                alert('친구를 선택하세요.');
                return;
            }

            Kakao.API.request({
                url: '/v1/api/talk/friends/message/send',
                data: {
                    receiver_uuids: [selectedFriendUUID],
                    template_id: 120980
                }
            })
            .then(response => {
                alert('메시지 전송 성공!');
                console.log('전송 결과:', response);
            })
            .catch(error => {
                alert('메시지 전송 실패');
                console.error('에러:', error);
            });
        }

        // 로그인 후 초기화
        function afterLogin() {
            showNickname();
            showFriends();
        }

        // 페이지 로드시 이미 로그인 상태면 초기화
        if (Kakao.Auth.getAccessToken()) {
            afterLogin();
        }

        // 로그인 버튼 클릭 이벤트
        document.getElementById('kakao-login-btn').addEventListener('click', () => {
            Kakao.Auth.login({
                scope: 'friends',
                success: () => afterLogin(),
                fail: err => console.error('로그인 실패:', err)
            });
        });
    </script>
</body>
</html>
